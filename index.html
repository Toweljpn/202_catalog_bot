<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>製品説明チャットボット（試作）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body style="font-family: system-ui, sans-serif; max-width: 720px; margin: 20px auto; padding: 16px;">
    <h2>製品説明チャットボット（試作）</h2>
    <p>商品について知りたいことを入力してください。</p>

    <input
      id="q"
      style="width: 100%; padding: 8px; margin-top: 8px;"
      placeholder="例）コンパクトに飾れる木目込みの雛人形はありますか？"
    />
    <button style="margin-top: 8px; padding: 6px 12px;" onclick="ask()">
      送信
    </button>

    <h3 style="margin-top: 24px;">回答</h3>
    <div id="out" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 12px; min-height: 80px;"></div>

<script>
  async function ask() {
    const input = document.getElementById("q");
    const query = input.value.trim();
    const out = document.getElementById("out");

    if (!query) {
      out.textContent = "質問を入力してください。";
      return;
    }

    out.textContent = "検索中 & 回答生成中…";

    try {
      // ① 検索API
      const searchResp = await fetch("/api/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: query }),  // ← ここが重要
      });
      const searchData = await searchResp.json();

      if (!searchResp.ok) {
        out.textContent =
          "検索エラー: " + (searchData.error || searchResp.status);
        return;
      }

      // ② 回答生成API
      const chatResp = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: query,                 // ← ここも必ず入れる
          contexts: searchData.results || [],
        }),
      });
      const chatData = await chatResp.json();

      if (!chatResp.ok) {
        out.textContent =
          "APIエラー: " + (chatData.error || chatResp.status);
        return;
      }

      out.textContent =
        chatData.answer || JSON.stringify(chatData, null, 2);
    } catch (e) {
      console.error(e);
      out.textContent = "通信エラー: " + e.message;
    }
  }
</script>
  </body>
</html>
